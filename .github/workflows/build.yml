name: Build and Release DS4Windows (SDK-style)

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build:
    name: Build and Publish (.NET SDK-style)
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore solution
        run: |
          echo "Restoring DS4WindowsWPF.sln"
          dotnet restore DS4WindowsWPF.sln

      - name: Build solution
        run: dotnet build DS4WindowsWPF.sln --configuration Release --no-restore

      - name: Publish executable projects (from solution)
        shell: pwsh
        run: |
          $pubDir = "$env:GITHUB_WORKSPACE\publish"
          if (Test-Path $pubDir) { Remove-Item $pubDir -Recurse -Force }
          New-Item -ItemType Directory -Path $pubDir | Out-Null

          # Find csproj files referenced by the solution (safer than publishing all csproj in repo)
          $slnPath = Join-Path $env:GITHUB_WORKSPACE 'DS4WindowsWPF.sln'
          $projPaths = Select-String -Path $slnPath -Pattern '\.csproj' -AllMatches |
                       ForEach-Object { $_.Matches } | ForEach-Object { $_.Value.Trim() } |
                       ForEach-Object { $_ -replace '\s*\\\s*', '\' } |
                       ForEach-Object { if ([System.IO.Path]::IsPathRooted($_)) { $_ } else { Join-Path $env:GITHUB_WORKSPACE $_ } }

          if ($projPaths.Count -eq 0) {
            Write-Error "No .csproj paths found in DS4WindowsWPF.sln."
            exit 1
          }

          foreach ($p in $projPaths) {
            if (-not (Test-Path $p)) {
              Write-Warning "Referenced project not found on disk: $p"
              continue
            }
            $projName = [System.IO.Path]::GetFileNameWithoutExtension($p)
            $out = Join-Path $pubDir $projName
            Write-Host "Publishing $p -> $out"
            dotnet publish $p -c Release -o $out -r win-x64 --self-contained false
          }

      - name: Package published files
        shell: pwsh
        id: package
        run: |
          $zip = "$env:GITHUB_WORKSPACE\ds4windows-$env:GITHUB_RUN_ID.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          if (Test-Path "$env:GITHUB_WORKSPACE\publish") {
            Compress-Archive -Path "$env:GITHUB_WORKSPACE\publish\*" -DestinationPath $zip -Force
            Write-Host "ZIP created: $zip"
            echo "artifact=$zip" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Error "No publish output found to package."
            exit 1
          }

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ds4windows-build
          path: ${{ steps.package.outputs.artifact }}

  release:
    name: Create Release (on tag)
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ds4windows-build
          path: release-artifact

      - name: Create GitHub Release and upload artifacts
        uses: softprops/action-gh-release@v1
        with:
          files: release-artifact/**
        env:
          GITHUB_TOKEN: ${{ secrets.ACCOUNT_TOKEN }}

      - name: (Optional) Show uploaded files
        run: ls -R release-artifact || true
